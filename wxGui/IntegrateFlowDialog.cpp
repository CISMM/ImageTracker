// -*- C++ -*- generated by wxGlade 0.4.1 on Mon Oct  1 20:35:55 2007

#include "IntegrateFlowDialog.h"

#include "FileSet.h"
#include "Logger.h"
#include "PipelineExecutor.h"
#include "wxUtils.h"

bool IntegrateFlowDialog::TransferDataToWindow()
{
    if (this->pipeline && 
        this->pipeline.IsNotNull() && 
        this->input && 
        this->input.IsNotNull())
    {
        this->slideStepSize->SetValue(this->pipeline->GetStepSize());
        this->textDirectory->SetValue(std2wx(this->input->GetFiles().GetDirectory()));
        return true;
    }
    else
    {
        return false;
    }
}

bool IntegrateFlowDialog::TransferDataFromWindow()
{
    std::string function("IntegrateFlowDialog::TransferDataFromWindow");
    this->pipeline->SetInput(this->input->GetImages());
    this->pipeline->SetStepSize(this->slideStepSize->GetValue());
    
    // Create an output file set
    FileSet outputFiles(this->input->GetFiles(), wx2std(this->textPrefix->GetValue()));
    outputFiles.SetDirectory(wx2std(this->textDirectory->GetValue()));
    this->pipeline->SetOutputFiles(outputFiles);
    
    // Create and launch a pipeline executor (uses another thread)
    PipelineExecutor* exec = new PipelineExecutor(this->pipeline);
    exec->SetOpenFiles(this->checkOpenOutput->IsChecked());
    if (exec->Create() == wxTHREAD_NO_ERROR)
    {
        exec->Run();
    }
    else
    {
        Logger::warning << function << ": Unable able to create threaded pipeline execution object" << std::endl;
        delete exec;
    }
    
    return true;
}

void IntegrateFlowDialog::SetInput(DataSource::Pointer input)
{
    this->input = input;
}

IntegrateFlowDialog::IntegrateFlowDialog(wxWindow* parent, int id, const wxString& title, const wxPoint& pos, const wxSize& size, long style):
    wxDialog(parent, id, title, pos, size, wxDEFAULT_DIALOG_STYLE)
{
    // begin wxGlade: IntegrateFlowDialog::IntegrateFlowDialog
    sizer_53_staticbox = new wxStaticBox(this, -1, wxT("Output"));
    sizer_52_staticbox = new wxStaticBox(this, -1, wxT("Parameters"));
    label_39 = new wxStaticText(this, -1, wxT("Step size"));
    slideStepSize = new wxDoubleSlider(this, -1);
    label_40 = new wxStaticText(this, -1, wxT("Directory"));
    textDirectory = new wxTextCtrl(this, -1, wxT("."));
    btnBrowse = new wxButton(this, BTN_BROWSE, wxT("&Browse..."));
    label_41 = new wxStaticText(this, -1, wxT("Prefix"));
    textPrefix = new wxTextCtrl(this, -1, wxT("disp-"));
    checkOpenOutput = new wxCheckBox(this, -1, wxT("Open output when finished"));
    btnRun = new wxButton(this, wxID_OK, wxT("&Run"));
    btnHide = new wxButton(this, wxID_CANCEL, wxT("&Hide"));

    set_properties();
    do_layout();
    // end wxGlade
    
    this->pipeline = IntegrateFlowFieldPipeline::New();
    this->slideStepSize->SetRange(0.1, 1.0, 0.1);
    this->slideStepSize->SetValue(0.5);
}

IntegrateFlowDialog::~IntegrateFlowDialog()
{}

BEGIN_EVENT_TABLE(IntegrateFlowDialog, wxDialog)
    // begin wxGlade: IntegrateFlowDialog::event_table
    EVT_BUTTON(BTN_BROWSE, IntegrateFlowDialog::OnBrowse)
    // end wxGlade
END_EVENT_TABLE();


void IntegrateFlowDialog::OnBrowse(wxCommandEvent &event)
{
    wxDirDialog dir(this, wxT("Choose an output directory"), this->textDirectory->GetValue());
    if (dir.ShowModal() == wxID_OK)
    {
        this->textDirectory->SetValue(dir.GetPath().Append(std2wx(FileSet::PATH_DELIMITER)));
    }
}


// wxGlade: add IntegrateFlowDialog event handlers


void IntegrateFlowDialog::set_properties()
{
    // begin wxGlade: IntegrateFlowDialog::set_properties
    SetTitle(wxT("Integrate Flow"));
    slideStepSize->SetToolTip(wxT("Size of an integration step"));
    textDirectory->SetToolTip(wxT("Directory in which to save output"));
    btnBrowse->SetToolTip(wxT("Find a directory"));
    textPrefix->SetToolTip(wxT("Prefix to append to each integrated result image"));
    checkOpenOutput->SetToolTip(wxT("Create a new data source and open it when finished"));
    checkOpenOutput->Enable(false);
    btnRun->SetDefault();
    // end wxGlade
}


void IntegrateFlowDialog::do_layout()
{
    // begin wxGlade: IntegrateFlowDialog::do_layout
    wxBoxSizer* sizer_51 = new wxBoxSizer(wxVERTICAL);
    wxBoxSizer* sizer_54 = new wxBoxSizer(wxHORIZONTAL);
    wxStaticBoxSizer* sizer_53 = new wxStaticBoxSizer(sizer_53_staticbox, wxHORIZONTAL);
    wxFlexGridSizer* grid_sizer_19 = new wxFlexGridSizer(3, 3, 5, 5);
    wxStaticBoxSizer* sizer_52 = new wxStaticBoxSizer(sizer_52_staticbox, wxHORIZONTAL);
    sizer_52->Add(label_39, 0, wxADJUST_MINSIZE, 0);
    sizer_52->Add(slideStepSize, 1, wxEXPAND, 0);
    sizer_51->Add(sizer_52, 0, wxEXPAND, 0);
    grid_sizer_19->Add(label_40, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(textDirectory, 0, wxEXPAND|wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(btnBrowse, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(label_41, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(textPrefix, 0, wxEXPAND|wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(20, 20, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(20, 20, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(checkOpenOutput, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->Add(20, 20, 0, wxADJUST_MINSIZE, 0);
    grid_sizer_19->AddGrowableCol(1);
    sizer_53->Add(grid_sizer_19, 1, wxEXPAND, 0);
    sizer_51->Add(sizer_53, 1, wxEXPAND, 0);
    sizer_54->Add(btnRun, 0, wxADJUST_MINSIZE, 0);
    sizer_54->Add(btnHide, 0, wxADJUST_MINSIZE, 0);
    sizer_51->Add(sizer_54, 0, wxALIGN_CENTER_HORIZONTAL, 0);
    SetAutoLayout(true);
    SetSizer(sizer_51);
    sizer_51->Fit(this);
    sizer_51->SetSizeHints(this);
    Layout();
    // end wxGlade
}

